<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leaf Disease Detection</title>
  <!-- Modern font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
      color: #333;
    }
    h1 { margin-bottom: 24px; font-weight: 600; font-size: 2.2em; }
    .controls { display: flex; flex-direction: column; align-items: center; margin-bottom: 24px; }
    #imageInput, #detectButton {
      width: 80%; margin-bottom: 8px; padding: 12px; font-size: 1em; border-radius: 4px; border: 1px solid #ccc;
      cursor: pointer; transition: opacity 0.2s; font-family: inherit;
    }
    #imageInput:hover, #detectButton:hover { opacity: 0.8; }
    #note { font-size: 0.85em; color: #666; margin-bottom: 16px; }
    #preview { display: none; max-width: 80%; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 16px; transition: transform 0.2s; }
    #preview:hover { transform: scale(1.05); }
    #result { font-size: 1.1em; margin-bottom: 16px; min-height: 24px; font-weight: 500; }
    #links { margin-top: 24px; text-align: left; max-width: 100%; background: #f5f5f5; padding: 16px; border-radius: 4px; }
    #links p { font-size: 1.1em; font-weight: 600; margin-bottom: 12px; }
    #links ul { list-style: none; padding: 0; font-size: 1em; }
    #links li { margin-bottom: 8px; }
    #links a { color: #1a0dab; text-decoration: none; }
    #links a:hover { text-decoration: underline; }
    #wiki { margin-top: 32px; text-align: left; max-width: 100%; padding: 16px 0; border-top: 1px solid #ddd; }
    /* Ensure wiki content images fit */
    #wiki img { max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <h1>Leaf Disease Detection</h1>
  <div class="controls">
    <input type="file" id="imageInput" accept="image/*" />
    <img id="preview" alt="Image Preview" />
    <button id="detectButton">Detect</button>
    <div id="note">Prediction only for reference, please consult a specialist if needed.</div>
  </div>
  <div id="result"></div>
  <div id="links"></div>
  <div id="wiki"></div>

  <script>
    const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');

    // Image preview
    imageInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) { preview.style.display = 'none'; return; }
      const reader = new FileReader();
      reader.onload = () => { preview.src = reader.result; preview.style.display = 'block'; };
      reader.readAsDataURL(file);
    });

    document.getElementById('detectButton').addEventListener('click', async () => {
      const resultDiv = document.getElementById('result');
      const linksDiv = document.getElementById('links');
      const wikiDiv = document.getElementById('wiki');
      resultDiv.innerText = '';
      linksDiv.innerHTML = '';
      wikiDiv.innerHTML = '';

      if (!imageInput.files || imageInput.files.length === 0) {
        alert('Please select an image first.');
        return;
      }

      const formData = new FormData();
      formData.append('file', imageInput.files[0]);
      resultDiv.innerText = 'Detecting...';

      let diseaseName = '';
      try {
        const response = await fetch('/predict', { method: 'POST', body: formData });
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();

        // Not a leaf: show message and optional leaf confidence
        if (!data.disease) {
          const leafInfo = (typeof data.leaf_confidence === 'number')
            ? ` (leaf conf: ${(data.leaf_confidence * 100).toFixed(1)}%)`
            : '';
          resultDiv.innerText = (data.message || 'Image not recognized as a valid leaf.') + leafInfo;
          return;
        }

        // Leaf: prefer display_name from backend; fall back to parsing disease label
        diseaseName = data.display_name || (
          (data.disease || '').includes('___')
            ? (data.disease || '').split('___').pop().replace(/_/g, ' ')
            : (data.disease || '').replace(/_/g, ' ')
        );
        const confText = (typeof data.confidence === 'number')
          ? ` (conf: ${(data.confidence * 100).toFixed(1)}%)`
          : '';
        resultDiv.innerText = `Disease: ${diseaseName}${confText}`;
      } catch (err) {
        console.error('Prediction error:', err);
        resultDiv.innerText = 'Detection failed, please try again.';
        return;
      }

      // Provide search links
      const query = encodeURIComponent(diseaseName);
      linksDiv.innerHTML = `
        <p>Search online for more information:</p>
        <ul>
          <li><a href="https://en.wikipedia.org/wiki/${query}" target="_blank">Wikipedia: ${diseaseName}</a></li>
          <li><a href="https://www.google.com/search?q=${query}" target="_blank">Google Search</a></li>
          <li><a href="https://www.bing.com/search?q=${query}" target="_blank">Bing Search</a></li>
        </ul>
      `;

      // Fetch and display Wikipedia HTML content below
      try {
        const apiUrl = `https://en.wikipedia.org/api/rest_v1/page/html/${query}`;
        const wikiResponse = await fetch(apiUrl);
        if (wikiResponse.ok) {
          const html = await wikiResponse.text();
          wikiDiv.innerHTML = html;
        } else {
          wikiDiv.innerText = 'Wikipedia content not available.';
        }
      } catch (err) {
        console.error('Wiki fetch error:', err);
        wikiDiv.innerText = 'Failed to load Wikipedia content.';
      }
    });
  </script>
</body>
</html>
